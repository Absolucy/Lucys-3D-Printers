[gcode_macro MEASURE_BELT_TENSION]
description = Generates a resonance graph used to ensure belts are equally tensioned.
gcode:
    {% set rounds = params.ROUNDS|default(1)|int %}
	{% for n in range(rounds) %}
		{% set suffix = ("_" + (n + 1)|string) if n > 0 else "" %}
		{action_respond_info("Testing upper belt tension, round {}".format(n + 1))}
		TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper{suffix}
		{action_respond_info("Testing lower belt tension, round {}".format(n + 1))}
		TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower{suffix}
	{% endfor %}
	{action_respond_info("Completed {} round{} of belt tension testing".format(rounds, "s" if rounds > 1 else ""))}
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/klipper_config/config/scripts/generate-belt-tension-graph
timeout = 90.
verbose = True
